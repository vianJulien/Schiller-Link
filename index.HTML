<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>ChatVie V1.2</title>

    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Schiller">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta id="meta-theme" name="theme-color" content="#ffffff">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>
<body onclick="ui.hideCtx()">

    <div id="ctx-menu">
        <div class="ctx-item" onclick="core.regenerate()"> é‡æ–°ç”Ÿæˆå›ç­”</div>
    </div>

    <div id="sidebar-overlay" onclick="ui.toggleSidebar(false)"></div>
    <div id="sidebar">
        <div class="sb-header">
            <span>ARCHIVES</span> <span onclick="ui.toggleSidebar(false)" style="cursor:pointer; padding:5px;">âœ•</span>
        </div>
        <button class="btn primary" style="margin:15px 15px 5px 15px; width:auto;" onclick="core.newSession()">+ New Chat</button>
        
        <div class="sb-list" id="session-list"></div>
        
        <div style="padding:15px; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:10px;">
            <button class="btn" style="width:100%; border-color:var(--accent); color:var(--accent); font-weight:bold;" onclick="ui.nav('tune'); ui.toggleSidebar(false);">
                 Personality Tuning
            </button>
            <button class="btn" style="width:100%; color:var(--text-sub); border:none; background:var(--bg);" onclick="ui.showLog(); ui.toggleSidebar(false);">
                 Update Log (V1.2)
            </button>
        </div>
    </div>

    <div id="p-chat" class="page active">
        <header>
            <button class="h-btn" onclick="ui.toggleSidebar(true)">â˜°</button>
            <h1 id="header-title">Schiller</h1> 
            <div>
                <button id="tts-indicator" class="h-btn" onclick="core.toggleAutoTTS()" title="Auto-Read">ğŸ”ˆ</button>
                <button class="h-btn" onclick="ui.modal(true)">âš™ï¸</button>
            </div>
        </header>
        <div id="chat-box"></div>
        
        <div id="input-area">
            <div id="preview-area"></div>
            <div class="input-row">
                <input type="file" id="file-input" accept=".pdf,.docx,.txt,.md" style="display:none" onchange="core.handleFile(this)">
                <button class="icon-btn" onclick="document.getElementById('file-input').click()">ğŸ“„</button>
                <input type="file" id="img-input" accept="image/*" style="display:none" onchange="core.handleImg(this)">
                <button class="icon-btn" onclick="document.getElementById('img-input').click()">ğŸ“</button>
                <textarea id="u-in" placeholder="Message..."></textarea>
                <button class="btn" onclick="core.send()" style="background:var(--accent);border:none;color:white;width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:20px;">â†‘</button>
            </div>
        </div>
    </div>

    <div id="p-cal" class="page">
        <header><h1>Calendar</h1></header>
        
        <div class="clock-row">
            <div class="clock"><div id="t-cn" class="clock-t">--:--</div><div class="clock-l">Beijing</div></div>
            <div class="clock"><div id="t-ny" class="clock-t">--:--</div><div class="clock-l">New York</div></div>
        </div>

        <div class="cal-controls" style="display:flex; justify-content:space-between; align-items:center; padding:10px 15px;">
            <button class="icon-btn" onclick="calendar.changeMonth(-1)">â®</button>
            <div id="cal-title" style="font-weight:bold; font-size:1.1rem; color:var(--accent);">Loading...</div>
            <button class="icon-btn" onclick="calendar.changeMonth(1)">â¯</button>
        </div>

        <div id="cal-grid" class="cal-grid"></div>

        <div style="padding:15px 15px 5px 15px; font-weight:bold; color:var(--text-sub); border-top:1px solid var(--border); margin-top:15px; font-size:0.9rem;">
            Plans for: 
            <span id="selected-date-label" style="color:var(--accent);">Today</span>
        </div>
        
        <div id="evt-list" style="flex:1;overflow-y:auto;padding:0 15px 15px 15px;"></div>

        <div id="add-box" style="padding:10px;background:var(--card);border-top:1px solid var(--border);display:flex;gap:8px;">
            <input type="time" id="ev-t" value="09:00" class="inp" style="width:auto;margin:0;">
            <input type="text" id="ev-txt" placeholder="Plan for this day..." class="inp" style="margin:0;flex:1;">
            <button class="btn" onclick="calendar.addEv()" style="background:var(--accent);border:none;color:white;width:40px;height:40px;border-radius:8px;">+</button>
        </div>
    </div>

    <div id="p-tune" class="page" style="background:var(--card);">
        <header>
            <button class="h-btn" onclick="ui.nav('chat')">â†</button>
            <h1>Personality Engine</h1>
            <div style="width:30px"></div>
        </header>
        <div style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:25px;">
            
            <div class="tune-card">
                <div class="tune-head"> Warmth (æ¸©æš–) <span id="val-warm" class="tune-val">50</span>%</div>
                <input type="range" id="rng-warm" class="slider" min="0" max="100" value="50" oninput="ui.updateTune('warm', this.value)">
                <div class="tune-desc">Cold / Distant <span style="float:right">Affectionate</span></div>
            </div>

            <div class="tune-card">
                <div class="tune-head"> Directness (ç›´æ¥æ€§) <span id="val-direct" class="tune-val">50</span>%</div>
                <input type="range" id="rng-direct" class="slider" min="0" max="100" value="50" oninput="ui.updateTune('direct', this.value)">
                <div class="tune-desc">Evasive / Polite <span style="float:right">Blunt / Direct</span></div>
            </div>

            <div class="tune-card">
                <div class="tune-head"> Intellectualism (çŸ¥è¯†åˆ†å­) <span id="val-intel" class="tune-val">50</span>%</div>
                <input type="range" id="rng-intel" class="slider" min="0" max="100" value="50" oninput="ui.updateTune('intel', this.value)">
                <div class="tune-desc">Casual / Simple <span style="float:right">Academic / Deep</span></div>
            </div>

            <div class="tune-card">
                <div class="tune-head"> Empathy (åŒç†å¿ƒ) <span id="val-empathy" class="tune-val">50</span>%</div>
                <input type="range" id="rng-empathy" class="slider" min="0" max="100" value="50" oninput="ui.updateTune('empathy', this.value)">
                <div class="tune-desc">Logical / Detached <span style="float:right">Compassionate</span></div>
            </div>

            <div class="tune-card">
                <div class="tune-head"> Compliance (é¡ºä»åº¦) <span id="val-obed" class="tune-val">50</span>%</div>
                <input type="range" id="rng-obed" class="slider" min="0" max="100" value="50" oninput="ui.updateTune('obed', this.value)">
                <div class="tune-desc">Stubborn / Independent <span style="float:right">Submissive</span></div>
            </div>

            <div style="margin-top:20px; text-align:center;">
                <p style="font-size:0.8rem; color:var(--text-sub); margin-bottom:15px;">
                    è°ƒèŠ‚å®Œæ¯•åï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å°†è‡ªåŠ¨ä¿å­˜å¹¶å‘é€æµ‹è¯•æ¶ˆæ¯ï¼š<br>"ä»Šæ™šæˆ‘æ„Ÿåˆ°å­¤ç‹¬"
                </p>
                <button class="btn primary" onclick="core.testPersonality()">Save & Test</button>
            </div>
        </div>
    </div>

    <nav>
        <div class="nav-item active" onclick="ui.nav('chat')"><span> Chat</span></div>
        <div class="nav-item" onclick="ui.nav('cal')"><span> Plan</span></div>
    </nav>

    <div id="set-modal">
        <div class="modal">
            <div class="tabs">
                <div class="tab active" onclick="ui.tab('conn')">Chat</div>
                <div class="tab" onclick="ui.tab('voice')">Audio</div>
                <div class="tab" onclick="ui.tab('mem')">Memory</div>
                <div class="tab" onclick="ui.tab('bkp')">Data</div>
            </div>

         <div id="tab-conn" class="tab-content active">
            <button class="btn" onclick="ui.toggleTheme()" style="width:100%; margin-bottom:15px; background:var(--bg); color:var(--text); border:1px solid var(--accent); font-weight:bold;">
                ğŸŒ— Switch Theme (Day/Night)
            </button>

            <label style="margin-top:10px;">API Format (åº•å±‚åè®®)</label>
            <select id="c-fmt" class="inp" style="border-color:var(--accent); color:var(--accent); font-weight:bold;">
                <option value="openai">OpenAI æ ¼å¼ (é€šç”¨/DeepSeek/GPT)</option>
                <option value="gemini">Google Gemini æ ¼å¼</option>
            </select>

            <div class="row" style="display:flex;gap:10px; margin-bottom:12px;">
                <button class="btn" style="flex:1" onclick="core.preset('ds')">DeepSeek</button>
                <button class="btn" style="flex:1" onclick="core.preset('oa')">GPT-4o</button>
                <button class="btn" style="flex:1" onclick="core.preset('gemini')">Gemini</button>
            </div>

            <label>Chat API Key</label><input type="password" id="c-key" class="inp">
            <label>Endpoint</label><input type="text" id="c-url" class="inp">
            <label>Model</label><input type="text" id="c-mod" class="inp">
            <label>Persona</label><textarea id="c-per" class="inp" rows="3"></textarea>
            
            <div style="background:var(--card); padding:10px; border-radius:8px; border:1px solid var(--border); margin-bottom:12px;">
                <label>Temperature: <span id="t-val" style="color:var(--accent)">1.0</span> (å‘æ•£åº¦)</label>
                <input type="range" id="c-temp" class="slider" min="0" max="2" step="0.1" value="1.0" oninput="document.getElementById('t-val').innerText=this.value">
                
                <label>Freq Penalty: <span id="val-freq" style="color:var(--accent)">0.0</span> (æ‹’ç»é‡å¤)</label>
                <input type="range" id="c-freq" class="slider" min="-2" max="2" step="0.1" value="0" oninput="document.getElementById('val-freq').innerText=this.value">
                
                <label>Pres Penalty: <span id="val-pres" style="color:var(--accent)">0.0</span> (å¼•å…¥æ–°è¯)</label>
                <input type="range" id="c-pres" class="slider" min="-2" max="2" step="0.1" value="0" oninput="document.getElementById('val-pres').innerText=this.value">

                <label style="margin-top:10px">Max Tokens (0=Default)</label>
                <input type="number" id="c-max" class="inp" value="0">

                <label style="margin-top:10px">Min Output (æœ€ä½å›å¤å­—æ•°):</label>
                <input type="number" id="c-min" class="inp" placeholder="ä¾‹å¦‚: 500" style="margin-bottom:0;">
                <small style="color:var(--text-sub); font-size:0.7rem;">æç¤ºï¼šAI ä¼šå°è¯•ä»¥æ­¤å­—æ•°ä½œä¸ºå›å¤çš„åº•çº¿ã€‚</small>
            </div>

            <button class="btn primary" onclick="core.saveConn()">Save Config</button>
        </div>
            
            <div id="tab-voice" class="tab-content">
                 <label>Voice Engine</label>
                <div class="row" style="display:flex;gap:10px;">
                    <button class="btn" style="flex:1" onclick="core.setVoiceMode('native')">Native (Free)</button>
                    <button class="btn" style="flex:1" onclick="core.setVoiceMode('openai')">OpenAI (Pro)</button>
                </div>
                <input type="text" id="v-mode-disp" class="inp" disabled style="text-align:center; margin-top:10px; color:var(--accent);">
                <div id="openai-voice-opts" style="display:none; margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
                    <label>Audio Key</label><input type="password" id="v-key" class="inp" placeholder="sk-...">
                    <label>Voice</label>
                    <select id="v-voice" class="inp">
                        <option value="onyx">Onyx</option><option value="alloy">Alloy</option><option value="nova">Nova</option>
                    </select>
                </div>
                <button class="btn primary" onclick="core.saveVoice()">Save Voice</button>
            </div>

            <div id="tab-mem" class="tab-content">
                 <div style="margin-bottom:10px;background:var(--card);padding:10px;border-radius:8px;border:1px solid var(--border);">
                    <input type="text" id="new-mem-keys" class="inp" placeholder="Keywords">
                    <textarea id="new-mem-info" class="inp" rows="2" placeholder="Detail..."></textarea>
                    <button class="btn" style="width:100%;border-color:var(--accent);color:var(--accent)" onclick="core.addMem()">Add Memory</button>
                </div>
                <div id="mem-list-container"></div>
            </div>

            <div id="tab-bkp" class="tab-content">
                <button class="btn" style="width:100%;margin-bottom:10px" onclick="core.exportData()">ğŸ“¤ Export Data</button>
                <input type="file" id="import-file" style="display:none" onchange="core.importData(this)">
                <button class="btn" style="width:100%;border-color:#f85149;color:#f85149" onclick="document.getElementById('import-file').click()">ğŸ“¥ Import Data</button>
            </div>

            <button class="btn" onclick="ui.modal(false)" style="width:100%; margin-top:10px; border:none; color:var(--text-sub)">Close</button>
        </div>
    </div>

    <div id="log-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:250; justify-content:center; align-items:center; backdrop-filter: blur(3px);">
        <div style="background:var(--bg); width:90%; max-height:80vh; border-radius:16px; border:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
            <div style="padding:20px; border-bottom:1px solid var(--border); font-weight:bold; font-size:1.2rem; color:var(--text); display:flex; justify-content:space-between; align-items:center;">
                ğŸ“ Update Log
                <button onclick="ui.hideLog()" style="background:none; border:none; font-size:1.2rem; cursor:pointer; color:var(--text-sub);">âœ•</button>
            </div>
            <div id="log-content" style="padding:20px; overflow-y:auto; flex:1; color:var(--text); line-height:1.6; font-size:0.95rem;">
                </div>
        </div>
    </div>

    <script src="js/config.js?v=1.2"></script>
    <script src="js/ui.js?v=1.2"></script>
    <script src="js/calendar.js?v=1.2"></script>
    <script src="js/engine.js?v=1.2"></script>

</body>
</html>