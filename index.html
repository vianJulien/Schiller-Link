<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ChatVie V11</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Schiller">
<link rel="apple-touch-icon" href="icon.png">

<link rel="icon" type="image/png" href="icon.png">
<meta name="mobile-web-app-capable" content="yes">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

<script>
    // ËÆæÁΩÆ PDF.js Worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<style>
    :root { --bg:#0d1117; --card:#161b22; --border:#30363d; --text:#c9d1d9; --accent:#58a6ff; --user:#1f6feb; --ai:#21262d; }
    body { font-family:-apple-system,sans-serif; background:var(--bg); color:var(--text); margin:0; height:100vh; display:flex; flex-direction:column; overflow:hidden; }
    
    /* Layout */
    .page { display:none; flex:1; flex-direction:column; overflow:hidden; position:relative; }
    .page.active { display:flex; }
    nav { height:55px; background:rgba(13,17,23,0.98); border-top:1px solid var(--border); display:flex; z-index:90; }
    .nav-item { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#8b949e; cursor:pointer; }
    .nav-item.active { color:var(--accent); }
    
    /* Header */
    header { padding:12px 15px; background:rgba(13,17,23,0.95); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; z-index:91; }
    .h-btn { background:none; border:none; font-size:1.4rem; cursor:pointer; padding:5px; color:var(--text); }
    h1 { margin:0; font-size:1rem; font-weight:600; letter-spacing:1px; }

    /* Sidebar */
    #sidebar-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:150; }
    #sidebar { position:fixed; top:0; left:-260px; width:260px; height:100%; background:#161b22; border-right:1px solid var(--border); transition:left 0.3s ease; z-index:160; display:flex; flex-direction:column; }
    #sidebar.open { left:0; }
    .sb-header { padding:20px; border-bottom:1px solid var(--border); font-weight:bold; letter-spacing:1px; display:flex; justify-content:space-between; }
    .sb-list { flex:1; overflow-y:auto; padding:10px; }
    .sb-item { padding:12px; margin-bottom:5px; border-radius:6px; cursor:pointer; color:#8b949e; transition:0.2s; position:relative; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sb-item.active { background:rgba(88,166,255,0.15); color:var(--accent); border-left:3px solid var(--accent); }
    .sb-del { position:absolute; right:5px; top:10px; color:#f85149; background:none; border:none; display:none; }
    .sb-item:hover .sb-del { display:block; }
    .new-chat-btn { margin:15px; padding:12px; background:var(--accent); border:none; color:white; border-radius:8px; font-weight:bold; cursor:pointer; text-align:center; }

    /* Chat UI */
    #chat-box { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:15px; scroll-behavior:smooth; }
    .bubble { padding:10px 14px; border-radius:12px; max-width:85%; line-height:1.5; font-size:0.95rem; word-wrap:break-word; position:relative; }
    .u-msg { align-self:flex-end; background:var(--user); color:#fff; border-bottom-right-radius:2px; }
    .a-msg { align-self:flex-start; background:var(--ai); border:1px solid var(--border); border-bottom-left-radius:2px; padding-bottom:25px; }
    .bubble img { max-width:100%; border-radius:8px; margin-top:5px; display:block; }
    .file-tag { display:inline-block; background:rgba(255,255,255,0.1); padding:4px 8px; border-radius:4px; font-size:0.8rem; margin-bottom:5px; border:1px solid rgba(255,255,255,0.2); }
    .replay-btn { position:absolute; bottom:5px; left:10px; font-size:0.8rem; cursor:pointer; opacity:0.5; }
    
    /* Input Area */
    #input-area { padding:10px; background:var(--card); border-top:1px solid var(--border); display:flex; flex-direction:column; gap:5px; }
    .input-row { display:flex; gap:8px; align-items:flex-end; width:100%; }
    #u-in { flex:1; background:var(--bg); border:1px solid var(--border); color:#fff; padding:10px; border-radius:8px; resize:none; height:24px; outline:none; font-family:inherit; }
    .icon-btn { font-size:1.2rem; background:none; border:none; cursor:pointer; padding:0 5px; color:#8b949e; line-height:44px; }
    
    /* Previews */
    #preview-area { display:none; gap:10px; padding:0 5px; flex-wrap:wrap; }
    .preview-item { position:relative; background:#21262d; border:1px solid var(--accent); border-radius:6px; padding:5px 10px; font-size:0.8rem; color:var(--accent); display:flex; align-items:center; gap:5px; }
    .preview-img { width:40px; height:40px; object-fit:cover; border-radius:4px; }
    .close-prev { cursor:pointer; color:#f85149; font-weight:bold; margin-left:5px; }

    /* Settings & Others */
    .clock-row { display:flex; gap:10px; padding:10px; background:var(--card); border-bottom:1px solid var(--border); }
    .clock { flex:1; text-align:center; padding:8px; background:var(--bg); border-radius:6px; border:1px solid var(--border); }
    .clock-t { font-size:1.1rem; font-weight:bold; color:var(--accent); font-family:monospace; }
    .clock-l { font-size:0.7rem; color:#8b949e; }
    #evt-list { flex:1; overflow-y:auto; padding:15px; }
    .evt { background:var(--card); border:1px solid var(--border); border-radius:8px; padding:12px; margin-bottom:10px; position:relative; }
    .evt-n { font-size:0.85rem; color:#8b949e; margin-top:5px; padding-top:5px; border-top:1px dashed #30363d; font-style:italic; }
    .del { position:absolute; top:5px; right:8px; color:#f85149; background:none; border:none; font-size:1.1rem; cursor:pointer; }
    
    #set-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:200; justify-content:center; align-items:flex-start; overflow-y:auto; }
    .modal { background:var(--card); width:90%; margin-top:5vh; padding:20px; border-radius:12px; border:1px solid var(--border); box-sizing:border-box; margin-bottom:5vh;}
    .tabs { display:flex; border-bottom:1px solid var(--border); margin-bottom:15px; }
    .tab { flex:1; padding:10px; text-align:center; cursor:pointer; color:#8b949e; border-bottom:2px solid transparent; }
    .tab.active { color:var(--accent); border-bottom-color:var(--accent); font-weight:bold; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .row { display:flex; justify-content:space-between; margin-bottom:10px; gap:10px; }
    .btn { padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:#fff; cursor:pointer; text-align:center; }
    .btn.primary { background:#238636; border:none; width:100%; padding:10px; font-weight:bold; margin-top:15px; }
    .inp { width:100%; padding:10px; background:#0d1117; border:1px solid #30363d; color:#fff; border-radius:6px; margin-bottom:10px; box-sizing:border-box; outline:none; }
    .mem-card { background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:10px; margin-bottom:10px; position:relative; }
    .mem-keys { color:var(--accent); font-size:0.8rem; font-weight:bold; margin-bottom:4px; }
    .mem-del { position:absolute; top:5px; right:5px; color:#f85149; background:none; border:none; cursor:pointer; }
</style>
</head>
<body>

<div id="sidebar-overlay" onclick="ui.toggleSidebar(false)"></div>
<div id="sidebar">
    <div class="sb-header">
        <span>ARCHIVES</span> <span onclick="ui.toggleSidebar(false)">‚úï</span>
    </div>
    <button class="new-chat-btn" onclick="core.newSession()">+ New Chat</button>
    <div class="sb-list" id="session-list"></div>
</div>

<div id="p-chat" class="page active">
    <header>
        <button class="h-btn" onclick="ui.toggleSidebar(true)">‚ò∞</button>
        <h1 id="header-title">Schiller</h1> 
        <div>
            <button id="tts-indicator" class="h-btn" onclick="core.toggleAutoTTS()" title="Auto-Read">üîà</button>
            <button class="h-btn" onclick="ui.modal(true)">‚öôÔ∏è</button>
        </div>
    </header>
    <div id="chat-box"></div>
    
    <div id="input-area">
        <div id="preview-area"></div>
        <div class="input-row">
            <input type="file" id="file-input" accept=".pdf,.docx,.txt,.md" style="display:none" onchange="core.handleFile(this)">
            <button class="icon-btn" onclick="document.getElementById('file-input').click()">üìÑ</button>
            
            <input type="file" id="img-input" accept="image/*" style="display:none" onchange="core.handleImg(this)">
            <button class="icon-btn" onclick="document.getElementById('img-input').click()">üìé</button>
            
            <textarea id="u-in" placeholder="Message..."></textarea>
            <button class="btn" onclick="core.send()" style="background:var(--accent);border:none;">‚Üë</button>
        </div>
    </div>
</div>

<div id="p-cal" class="page">
    <header><h1>Schedule</h1></header>
    <div class="clock-row">
        <div class="clock"><div id="t-cn" class="clock-t">--:--</div><div class="clock-l">Beijing</div></div>
        <div class="clock"><div id="t-ny" class="clock-t">--:--</div><div class="clock-l">New York</div></div>
    </div>
    <div id="evt-list"></div>
    <div id="add-box">
        <input type="time" id="ev-t" value="09:00" class="inp" style="width:auto;margin:0;">
        <input type="text" id="ev-txt" placeholder="Add event..." class="inp" style="margin:0;">
        <button class="btn" onclick="core.addEv()" style="background:var(--accent);border:none;">+</button>
    </div>
</div>

<nav>
    <div class="nav-item active" onclick="ui.nav('chat')"><span>üí¨ Link</span></div>
    <div class="nav-item" onclick="ui.nav('cal')"><span>üìÖ Plan</span></div>
</nav>

<div id="set-modal">
    <div class="modal">
        <div class="tabs">
            <div class="tab active" onclick="ui.tab('conn')">Chat</div>
            <div class="tab" onclick="ui.tab('voice')">Audio</div>
            <div class="tab" onclick="ui.tab('mem')">Memory</div>
            <div class="tab" onclick="ui.tab('bkp')">Backup</div>
        </div>

        <div id="tab-conn" class="tab-content active">
            <div class="row">
                <button class="btn" style="flex:1" onclick="core.preset('ds')">DeepSeek</button>
                <button class="btn" style="flex:1" onclick="core.preset('oa')">GPT-4o</button>
            </div>
            <label style="color:#8b949e">Chat API Key</label><input type="password" id="c-key" class="inp">
            <label style="color:#8b949e">Endpoint</label><input type="text" id="c-url" class="inp">
            <label style="color:#8b949e">Model</label><input type="text" id="c-mod" class="inp">
            <label style="color:#8b949e">Persona</label><textarea id="c-per" class="inp" rows="4"></textarea>
            <button class="btn primary" onclick="core.saveConn()">Save Config</button>
        </div>
        
        <div id="tab-voice" class="tab-content">
             <label style="color:#8b949e">Voice Engine</label>
            <div class="row">
                <button class="btn" style="flex:1" onclick="core.setVoiceMode('native')">Native (Free)</button>
                <button class="btn" style="flex:1" onclick="core.setVoiceMode('openai')">OpenAI (Pro)</button>
            </div>
            <input type="text" id="v-mode-disp" class="inp" disabled style="color:#8b949e; text-align:center; margin-top:10px">
            <div id="openai-voice-opts" style="display:none; margin-top:15px; border-top:1px solid #333; padding-top:15px;">
                <label style="color:#8b949e">Audio Key</label><input type="password" id="v-key" class="inp" placeholder="sk-...">
                <label style="color:#8b949e">Voice</label>
                <select id="v-voice" class="inp">
                    <option value="onyx">Onyx</option><option value="alloy">Alloy</option><option value="nova">Nova</option>
                </select>
            </div>
            <button class="btn primary" onclick="core.saveVoice()">Save Voice</button>
        </div>

        <div id="tab-mem" class="tab-content">
             <div style="margin-bottom:10px;background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;">
                <input type="text" id="new-mem-keys" class="inp" placeholder="Keywords">
                <textarea id="new-mem-info" class="inp" rows="2" placeholder="Detail..."></textarea>
                <button class="btn" style="width:100%;border-color:var(--accent);color:var(--accent)" onclick="core.addMem()">Add Memory</button>
            </div>
            <div id="mem-list-container"></div>
        </div>

        <div id="tab-bkp" class="tab-content">
            <button class="btn" style="width:100%;margin-bottom:10px" onclick="core.exportData()">üì§ Export Data</button>
            <input type="file" id="import-file" style="display:none" onchange="core.importData(this)">
            <button class="btn" style="width:100%;border-color:#f85149;color:#f85149" onclick="document.getElementById('import-file').click()">üì• Import Data</button>
        </div>

        <button class="btn" onclick="ui.modal(false)" style="width:100%; margin-top:10px; border:none; color:#8b949e">Close</button>
    </div>
</div>

<script>
const ui = {
    nav: (p) => {
        document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        document.getElementById(p==='chat'?'p-chat':'p-cal').classList.add('active');
        document.querySelectorAll('.nav-item')[p==='chat'?0:1].classList.add('active');
    },
    modal: (s) => { document.getElementById('set-modal').style.display = s?'flex':'none'; if(s) core.renderMemCards(); },
    tab: (t) => {
        document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        const map = {'conn':0, 'voice':1, 'mem':2, 'bkp':3};
        document.querySelectorAll('.tab')[map[t]].classList.add('active');
    },
    toggleSidebar: (open) => {
        const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebar-overlay');
        if(open) { sb.classList.add('open'); ov.style.display='block'; core.renderSessionList(); }
        else { sb.classList.remove('open'); ov.style.display='none'; }
    },
    bubble: (role, txt, img=null, file=null) => {
        const d = document.createElement('div'); d.className = `bubble ${role==='user'?'u-msg':'a-msg'}`;
        let content = "";
        if(img) content += `<img src="${img}">`;
        if(file) content += `<div class="file-tag">üìÑ ${file}</div>`;
        content += role==='user' ? txt : marked.parse(txt);
        
        if(role !== 'user') {
             const rawTxt = txt.replace(/"/g, '&quot;');
             content += `<div class="replay-btn" onclick="core.speak('${rawTxt}', true)">üîà Replay</div>`;
        }
        d.innerHTML = content;
        const t = document.createElement('span'); t.className='time';
        const now = new Date(); t.innerText = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        d.appendChild(t);
        const box = document.getElementById('chat-box'); box.appendChild(d); box.scrollTop=box.scrollHeight;
        return d;
    },
    addPreview: (type, src, name) => {
        const p = document.getElementById('preview-area');
        p.style.display = 'flex';
        const d = document.createElement('div'); d.className='preview-item';
        if(type==='img') d.innerHTML = `<img src="${src}" class="preview-img"><span class="close-prev" onclick="core.clearPreview('img')">√ó</span>`;
        else d.innerHTML = `üìÑ ${name} <span class="close-prev" onclick="core.clearPreview('file')">√ó</span>`;
        p.appendChild(d);
    },
    clearPreviews: () => { document.getElementById('preview-area').innerHTML=''; document.getElementById('preview-area').style.display='none'; }
};

const core = {
    conf: { url:'', key:'', model:'', persona:'' },
    voiceConf: { mode: 'native', key: '', voice: 'onyx' },
    mems: [], evts: [], sessions: {}, currSessId: null,
    autoTTS: false, 
    currUpload: { img: null, fileText: null, fileName: null },

    init: () => {
        // Load Configs (same as V10)
        ['url','key','model','persona'].forEach(k => core.conf[k] = localStorage.getItem('v11_'+k) || '');
        if(!core.conf.url) core.preset('ds');
        if(!core.conf.persona) core.conf.persona = "‰Ω†Âè´ËâæÂæ∑ÈáåÂÆâ¬∑Â∏≠ÂãíÔºåÊïôÊéà„ÄÇ";
        document.getElementById('c-url').value = core.conf.url;
        document.getElementById('c-key').value = core.conf.key;
        document.getElementById('c-mod').value = core.conf.model;
        document.getElementById('c-per').value = core.conf.persona;

        const v = localStorage.getItem('v11_voice'); if(v) core.voiceConf = JSON.parse(v); core.updateVoiceUI();
        
        try { core.mems = JSON.parse(localStorage.getItem('v11_mems') || '[]'); } catch(e){}
        try { core.evts = JSON.parse(localStorage.getItem('v11_evts') || '[]'); } catch(e){}
        try { core.sessions = JSON.parse(localStorage.getItem('v11_sessions') || '{}'); } catch(e){}
        core.currSessId = localStorage.getItem('v11_curr_id');
        
        if(!core.currSessId || !core.sessions[core.currSessId]) core.newSession();
        else core.loadSession(core.currSessId);

        core.renderEvt();
        setInterval(core.clockTick, 1000);
    },

    clockTick: () => {
        const n = new Date();
        const cn = new Date(n.getTime()+(n.getTimezoneOffset()*60000)+(3600000*8));
        const ny = new Date(n.toLocaleString("en-US",{timeZone:"America/New_York"}));
        document.getElementById('t-cn').innerText = `${String(cn.getHours()).padStart(2,'0')}:${String(cn.getMinutes()).padStart(2,'0')}`;
        document.getElementById('t-ny').innerText = `${String(ny.getHours()).padStart(2,'0')}:${String(ny.getMinutes()).padStart(2,'0')}`;
    },

    // --- CONFIG & DATA ---
    preset: (t) => {
        const d = t==='ds' ? ['https://api.deepseek.com/chat/completions','deepseek-chat'] : ['https://api.openai.com/v1/chat/completions','gpt-4o'];
        document.getElementById('c-url').value = d[0]; document.getElementById('c-mod').value = d[1];
    },
    saveConn: () => {
        core.conf.url = document.getElementById('c-url').value;
        core.conf.key = document.getElementById('c-key').value;
        core.conf.model = document.getElementById('c-mod').value;
        core.conf.persona = document.getElementById('c-per').value;
        ['url','key','model','persona'].forEach(k => localStorage.setItem('v11_'+k, core.conf[k]));
        alert('Saved.');
    },
    setVoiceMode: (m) => { core.voiceConf.mode = m; core.updateVoiceUI(); },
    updateVoiceUI: () => {
        document.getElementById('v-mode-disp').value = core.voiceConf.mode.toUpperCase();
        document.getElementById('openai-voice-opts').style.display = core.voiceConf.mode === 'openai' ? 'block' : 'none';
        document.getElementById('v-key').value = core.voiceConf.key;
        document.getElementById('v-voice').value = core.voiceConf.voice;
    },
    saveVoice: () => {
        core.voiceConf.key = document.getElementById('v-key').value;
        core.voiceConf.voice = document.getElementById('v-voice').value;
        localStorage.setItem('v11_voice', JSON.stringify(core.voiceConf));
        alert('Voice Saved.');
    },
    toggleAutoTTS: () => { core.autoTTS = !core.autoTTS; document.getElementById('tts-indicator').classList.toggle('active', core.autoTTS); if(core.autoTTS) core.speak("Audio On", true); },

    // --- FILES & IMAGES ---
    handleImg: (input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    let w=img.width, h=img.height, max=800;
                    if(w>max||h>max){ if(w>h){h*=max/w;w=max}else{w*=max/h;h=max} }
                    canvas.width=w; canvas.height=h; ctx.drawImage(img,0,0,w,h);
                    core.currUpload.img = canvas.toDataURL('image/jpeg', 0.7);
                    ui.addPreview('img', core.currUpload.img, '');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    },
    handleFile: async (input) => {
        if (input.files && input.files[0]) {
            const f = input.files[0];
            const name = f.name;
            let text = "";
            ui.addPreview('file', null, "Parsing " + name + "...");
            
            try {
                if(name.endsWith('.pdf')) {
                    const arrayBuffer = await f.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(' ') + "\n";
                    }
                } else if(name.endsWith('.docx')) {
                    const arrayBuffer = await f.arrayBuffer();
                    const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
                    text = result.value;
                } else {
                    text = await f.text(); // txt, md
                }
                
                core.currUpload.fileText = text;
                core.currUpload.fileName = name;
                ui.clearPreviews(); 
                ui.addPreview('file', null, name); // Update preview to show ready
                
            } catch(e) {
                alert("Parse Error: " + e.message);
                ui.clearPreviews();
            }
        }
    },
    clearPreview: (t) => {
        if(t==='img') core.currUpload.img = null;
        if(t==='file') { core.currUpload.fileText = null; core.currUpload.fileName = null; }
        ui.clearPreviews();
        document.getElementById('img-input').value=''; document.getElementById('file-input').value='';
    },

    // --- CHAT LOGIC ---
    send: async () => {
        const el = document.getElementById('u-in'); const txt = el.value.trim();
        if((!txt && !core.currUpload.img && !core.currUpload.fileText) || !core.conf.key) return;
        
        const sess = core.sessions[core.currSessId];
        if(sess.msgs.length===0 && txt) { sess.title = txt.substring(0,12)+'...'; document.getElementById('header-title').innerText = sess.title; }

        // User UI
        ui.bubble('user', txt, core.currUpload.img, core.currUpload.fileName);
        
        // Construct Msg
        let finalText = txt;
        if(core.currUpload.fileText) finalText += `\n\n[FILE CONTENT: ${core.currUpload.fileName}]\n${core.currUpload.fileText}\n[END FILE]`;
        
        let apiContent;
        if (core.currUpload.img) {
            apiContent = [ { type: "text", text: finalText || "Image." }, { type: "image_url", image_url: { url: core.currUpload.img } } ];
        } else { apiContent = finalText; }

        sess.msgs.push({role:'user', content:txt, img:core.currUpload.img, file:core.currUpload.fileName}); // Store display info
        core.saveSessions();

        const wasImg = core.currUpload.img;
        core.currUpload = { img:null, fileText:null, fileName:null };
        el.value=''; ui.clearPreviews();
        
        const aiDiv = ui.bubble('ai', 'Thinking...');

        // RAG
        let sys = core.conf.persona + `\n[Time:${new Date().toLocaleString()}]`;
        if(core.evts.length) sys += `\n[Schedule]:\n${core.evts.map(e=>`- ${e.t} ${e.d} (${e.n})`).join('\n')}`;
        const hits = core.mems.filter(m => m.keys.some(k => txt.includes(k)));
        if(hits.length) sys += `\n[Memory]:\n${hits.map(h=>`- ${h.info}`).join('\n')}`;

        const apiMsgs = [{role:'system', content:sys}];
        // History Reconstruct
        sess.msgs.forEach(m => {
            if(m === sess.msgs[sess.msgs.length-1]) {
                // This is current message, use constructed payload
                apiMsgs.push({role:'user', content: apiContent});
            } else {
                // History: skip images/files to save token/errors, just text
                apiMsgs.push({role:m.role, content:m.content + (m.file?` [File: ${m.file} sent]`:'')});
            }
        });

        if(wasImg && core.conf.url.includes('deepseek')) { aiDiv.innerHTML = "Error: DeepSeek cannot see images."; sess.msgs.pop(); return; }

        try {
            const res = await fetch(core.conf.url, {
                method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${core.conf.key}`},
                body: JSON.stringify({ model:core.conf.model, messages:apiMsgs, stream:true })
            });
            const r = res.body.getReader(); const dec = new TextDecoder();
            let final = ''; aiDiv.innerHTML='';
            
            while(true) {
                const {done,value} = await r.read(); if(done) break;
                const chunk = dec.decode(value,{stream:true});
                chunk.split('\n').forEach(l => {
                    if(l.startsWith('data: ') && l!=='data: [DONE]') {
                        try { final += JSON.parse(l.slice(6)).choices[0].delta.content||''; aiDiv.innerHTML = marked.parse(final); } catch(e){}
                    }
                });
                document.getElementById('chat-box').scrollTop = 99999;
            }
            sess.msgs.push({role:'assistant', content:final});
            core.saveSessions();
            aiDiv.innerHTML += `<div class="replay-btn" onclick="core.speak('${final.replace(/'/g, "\\'").replace(/\n/g, ' ')}', true)">üîà Replay</div>`;
            if(core.autoTTS) core.speak(final);
        } catch(e) { aiDiv.innerHTML = 'Error: '+e.message; }
    },

    // --- AUDIO & SESSIONS & MEMORY & BACKUP (Same logic) ---
    speak: async (text, force=false) => {
        if(!core.autoTTS && !force) return;
        const plain = text.replace(/[*#`]/g, '');
        if(core.voiceConf.mode === 'native') {
            const u = new SpeechSynthesisUtterance(plain);
            const voices = speechSynthesis.getVoices();
            const zh = voices.find(v => v.lang.includes('zh'));
            if(zh) u.voice = zh;
            speechSynthesis.speak(u);
        } else {
            const k = core.voiceConf.key || core.conf.key;
            if(!k) return;
            try {
                const res = await fetch('https://api.openai.com/v1/audio/speech', {
                    method: 'POST', headers: { 'Authorization': `Bearer ${k}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: "tts-1", input: plain, voice: core.voiceConf.voice })
                });
                const blob = await res.blob(); new Audio(URL.createObjectURL(blob)).play();
            } catch(e) {}
        }
    },
    newSession: () => { const id = Date.now().toString(); core.sessions[id] = {id, title:'New Chat', msgs:[]}; core.currSessId=id; core.saveSessions(); core.loadSession(id); ui.toggleSidebar(false); },
    loadSession: (id) => { if(!core.sessions[id]) return; core.currSessId=id; localStorage.setItem('v11_curr_id', id); document.getElementById('header-title').innerText=core.sessions[id].title; const box=document.getElementById('chat-box'); box.innerHTML=''; core.sessions[id].msgs.forEach(m=>ui.bubble(m.role==='assistant'?'ai':'user', m.content, m.img, m.file)); },
    saveSessions: () => localStorage.setItem('v11_sessions', JSON.stringify(core.sessions)),
    renderSessionList: () => { const list=document.getElementById('session-list'); list.innerHTML=''; Object.keys(core.sessions).sort().reverse().forEach(id=>{ const s=core.sessions[id]; const div=document.createElement('div'); div.className=`sb-item ${id===core.currSessId?'active':''}`; div.innerHTML=`${s.title}<button class="sb-del" onclick="core.delSess('${id}', event)">√ó</button>`; div.onclick=()=>{core.loadSession(id);ui.toggleSidebar(false);}; list.appendChild(div); }); },
    delSess: (id, e) => { e.stopPropagation(); if(!confirm('Delete?')) return; delete core.sessions[id]; core.saveSessions(); if(core.currSessId===id) core.newSession(); else core.renderSessionList(); },
    addMem: () => { const k=document.getElementById('new-mem-keys').value.trim(); const i=document.getElementById('new-mem-info').value.trim(); if(k&&i) { core.mems.push({keys:k.split(/[,Ôºå\s]+/).filter(k=>k), info:i}); localStorage.setItem('v11_mems', JSON.stringify(core.mems)); core.renderMemCards(); document.getElementById('new-mem-keys').value=''; document.getElementById('new-mem-info').value=''; } },
    delMem: (i) => { core.mems.splice(i,1); localStorage.setItem('v11_mems', JSON.stringify(core.mems)); core.renderMemCards(); },
    renderMemCards: () => { const b=document.getElementById('mem-list-container'); b.innerHTML=''; core.mems.forEach((m,i)=>{ b.innerHTML+=`<div class="mem-card"><div class="mem-keys"># ${m.keys.join(', ')}</div><div class="mem-info">${m.info}</div><button class="mem-del" onclick="core.delMem(${i})">√ó</button></div>`; }); },
    addEv: async () => { const t=document.getElementById('ev-t').value; const d=document.getElementById('ev-txt').value; if(d) { const ev={id:Date.now(),t,d,n:'Reviewing...'}; core.evts.push(ev); core.evts.sort((a,b)=>a.t.localeCompare(b.t)); localStorage.setItem('v11_evts', JSON.stringify(core.evts)); core.renderEvt(); document.getElementById('ev-txt').value=''; if(core.conf.key) { try { const res=await fetch(core.conf.url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${core.conf.key}`},body:JSON.stringify({model:core.conf.model,messages:[{role:'system',content:core.conf.persona},{role:'user',content:`Added: "${d}" at ${t}. Comment(Chinese, <15 chars):`}],stream:false})}); const j=await res.json(); ev.n=j.choices[0].message.content; localStorage.setItem('v11_evts',JSON.stringify(core.evts)); core.renderEvt(); } catch(e){} } } },
    delEv: (id) => { core.evts=core.evts.filter(e=>e.id!==id); localStorage.setItem('v11_evts', JSON.stringify(core.evts)); core.renderEvt(); },
    renderEvt: () => { const b=document.getElementById('evt-list'); b.innerHTML=''; core.evts.forEach(e=>{ b.innerHTML+=`<div class="evt"><div style="display:flex;justify-content:space-between"><b>${e.d}</b><span style="color:var(--accent)">${e.t}</span></div><div class="evt-n">${e.n}</div><button class="del" onclick="core.delEv(${e.id})">√ó</button></div>`; }); },
    exportData: () => { const d={conf:core.conf,voice:core.voiceConf,mems:core.mems,evts:core.evts,sessions:core.sessions}; const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='schiller_v11.json'; a.click(); },
    importData: (i) => { const r=new FileReader(); r.onload=(e)=>{ try { const d=JSON.parse(e.target.result); if(d.conf)['url','key','model','persona'].forEach(k=>localStorage.setItem('v11_'+k,d.conf[k])); if(d.voice)localStorage.setItem('v11_voice',JSON.stringify(d.voice)); if(d.mems)localStorage.setItem('v11_mems',JSON.stringify(d.mems)); if(d.evts)localStorage.setItem('v11_evts',JSON.stringify(d.evts)); if(d.sessions)localStorage.setItem('v11_sessions',JSON.stringify(d.sessions)); alert('Restored'); location.reload(); } catch(err){alert('Error');} }; r.readAsText(i.files[0]); }
};
core.init();
</script>
</body>
</html>